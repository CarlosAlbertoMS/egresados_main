<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizar Egresado</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Actualizar Información del Egresado</h1>
        <form id="updateForm" class="p-4 bg-white shadow rounded" method="POST">
            <!-- Matricula -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="matricula">Matrícula</label>
                <input type="text" id="matricula" name="matricula" class="form-control" required />
            </div>
            <!-- Apellidos -->
            <div class="row mb-3">
                <div class="col form-outline">
                    <label class="form-label" for="ap_paterno">Apellido Paterno</label>
                    <input type="text" id="ap_paterno" name="ap_paterno" class="form-control" required />
                </div>
                <div class="col form-outline">
                    <label class="form-label" for="ap_materno">Apellido Materno</label>
                    <input type="text" id="ap_materno" name="ap_materno" class="form-control" required />
                </div>
            </div>
            <!-- Nombres -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="nombres">Nombres</label>
                <input type="text" id="nombres" name="nombres" class="form-control" required />
            </div>
            <!-- CURP -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="curp">CURP</label>
                <input type="text" id="curp" name="curp" class="form-control" required />
            </div>
            <!-- Género -->
            <div class="mb-3">
                <label class="form-label" for="genero">Género</label>
                <select id="genero" name="genero" class="form-select" required>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                </select>
            </div>
            <!-- Fecha de nacimiento -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="fecha_nacimiento">Fecha de Nacimiento</label>
                <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control" />
            </div>
            <!-- Nacionalidad -->
            <div class="mb-3">
                <label class="form-label" for="nacionalidad">Nacionalidad</label>
                <select id="nacionalidad" name="nacionalidad" class="form-select" required>
                    <option value="Mexicana">Mexicana</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>
            <!-- Teléfono -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="telefono">Teléfono</label>
                <input type="text" id="telefono" name="telefono" class="form-control" required />
            </div>
            <!-- Lugar de Origen -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="lugar_origen">Lugar de Origen</label>
                <input type="text" id="lugar_origen" name="lugar_origen" class="form-control" required />
            </div>
            <!-- Otros campos -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="direccion_actual">Dirección Actual</label>
                <textarea class="form-control" id="direccion_actual" name="direccion_actual" rows="3" required></textarea>
            </div>

            <div class="mb-3 form-outline">
                <label class="form-label" for="imagen_url">Imagen URL</label>
                <input type="text" id="imagen_url" name="imagen_url" class="form-control" />
            </div>

            <!-- CV URL -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="cv_url">CV URL</label>
                <input type="text" id="cv_url" name="cv_url" class="form-control" />
            </div>

            <!-- Habilitado -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="habilitado">Habilitado</label>
                <input type="number" id="habilitado" name="habilitado" class="form-control" required />
            </div>

            <!-- Primer Empleo ID -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="primer_empleo_id">Primer Empleo ID</label>
                <input type="number" id="primer_empleo_id" name="primer_empleo_id" class="form-control" />
            </div>

            <!-- Bandera Enc -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="banderaEnc">Bandera Enc</label>
                <input type="number" id="banderaEnc" name="banderaEnc" class="form-control" required />
            </div>

            <!-- Carrera -->
            <div class="mb-3">
                <label class="form-label" for="carrera">Carrera</label>
                <select id="carrera" name="carrera" class="form-select" required>
                    <option value="2">Licenciatura en Ingeniería en Computación</option>
                    <option value="3">Licenciatura en Ingeniería en Diseño</option>
                    <option value="4">Licenciatura en Ingeniería en Electrónica</option>
                    <option value="5">Licenciatura en Ciencias Empresariales</option>
                    <option value="6">Licenciatura en Ingeniería en Alimentos</option>
                    <option value="7">Licenciatura en Matemáticas Aplicadas</option>
                    <option value="8">Maestría en Electrónica y Computación</option>
                    <option value="9">Doctorado en Electrónica y Computación</option>
                    <option value="10">Maestría en Computación con Especialidad en Sistemas Distribuidos</option>
                    <option value="11">Licenciatura en Ingeniería Industrial</option>
                    <option value="12">Licenciatura en Estudios Mexicanos</option>
                    <option value="13">Mestría en Ingeniería en Software</option>
                    <option value="14">Ingeniería en Mecatrónica</option>
                    <option value="15">Mestría en Administración de Negocios</option>
                    <option value="16">Mestría en Medios Interactivos</option>
                    <option value="17">Licenciatura en Ingeniería en Física Aplicada</option>
                    <option value="18">Maestría en Ciencias: Productos Naturales y Alimentos</option>
                    <option value="19">Mestría en Tecnología Avanzada de Manufactura</option>
                    <option value="20">Maestría en Tecnologías de Cómputo Aplicado</option>
                    <option value="21">Mestría en Electrónica, Opción: Sistemas Inteligentes Aplicados</option>
                    <option value="22">Maestría en Modelación Matematica</option>
                    <option value="23">Maestría en Diseño de Muebles</option>
                    <option value="24">Maestría en Diseño de Modas</option>
                    <option value="25">Maestría en Robótica</option>
                    <option value="26">Doctorado en Tecnologías de Cómputo Aplicado E Ingeniería de la Computación</option>
                    <option value="27">Doctorado en Electrónica, Opción: Sistemas Inteligentes Aplicados</option>
                    <option value="28">Doctorado en Robótica</option>
                    <option value="29">Doctorado en Modelación Matemática</option>
                    <option value="30">Maestría en Ciencias de Materiales</option>
                    <option value="31">Licenciatura en Ingeniería Mecánica Automotriz</option>
                    <option value="32">Licenciatura en Ingeniería Civil</option>
                    <option value="33">Doctorado en Ciencias: Productos Naturales y Alimentos</option>
                    <option value="34">Maestría en Inteligencia Artificial</option>
                    <option value="35">Doctorado en Inteligencia Artificial</option>
                    <option value="36">Ingeniería Química en Procesos Sostenibles</option>
                    <option value="37">Maestría en Ciencia de Datos</option>
                </select>
            </div>

            <!-- Generación -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="generacion">Generación</label>
                <input type="text" id="generacion" name="generacion" class="form-control" required />
            </div>

            <!-- Fecha de Inicio -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="fecha_inicio">Fecha de Inicio</label>
                <input type="text" id="fecha_inicio" name="fecha_inicio" class="form-control" required />
            </div>

            <!-- Fecha de Fin -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="fecha_fin">Fecha de Fin</label>
                <input type="text" id="fecha_fin" name="fecha_fin" class="form-control" required />
            </div>

            <!-- Promedio -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="promedio">Promedio</label>
                <input type="number" id="promedio" name="promedio" step="0.1" class="form-control" required />
            </div>

            <!-- Forma de Titulación -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="forma_titulacion">Forma de Titulación</label>
                <select id="forma_titulacion" name="forma_titulacion" class="form-select" required>
                    <option value="Tesis">Tesis</option>
                    <option value="CENEVAL">CENEVAL</option>
                    <option value="No titulado">No titulado</option>
                </select>
            </div>
            
            <!-- Fecha de Título -->
            <div class="mb-3 form-outline">
                <label class="form-label" for="fecha_titulo">Fecha de Título</label>
                <input type="date" id="fecha_titulo" name="fecha_titulo" class="form-control" required/>
            </div>

            <!-- Botón de enviar -->
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary w-100">Actualizar</button>
                <button type="button" class="btn btn-primary w-100" onclick="window.location.href='/listar'">Cancelar</button>
                <button type="button" class="btn btn-primary w-100" onclick="window.location.href='/listar'">Volver</button>
            </div>
            
        </form>
        <div class="text-end mt-4">
            <button id="logout" class="btn btn-danger btn-lg">Cerrar Sesión</button>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom Script -->
    <script>
          document.addEventListener("DOMContentLoaded", function () {
        const userToken = sessionStorage.getItem('userToken');

        if (!userToken) {
            // Si no hay token, redirigir al login
            window.location.href = "/login";
        }
    });
        // Función para cargar los datos del usuario en el formulario
        const urlParams = new URLSearchParams(window.location.search);
        const matricula = urlParams.get('matricula'); // Ahora matricula tiene el valor correcto

        console.log(matricula);
        if (matricula) {
            // Call the function to load the user data
            loadUserData(matricula);
        } else {
            alert("No se encontró la matrícula en la URL.");
        }

        
        function loadUserData(matricula) {
    fetch(`/reales/buscar?matricula=${matricula}`)
        .then(response => response.json())
        .then(data => {
            // Verifica si la clave 'data' existe y tiene elementos
            if (data.data && data.data.length > 0) {
                const user = data.data[0]; // Accede al primer elemento dentro de 'data'
                const cleanValue = (value) => value ? value.trim() : "";
                // Asignar valores a los campos del formulario
                document.getElementById('matricula').value = user.matricula.trim();
                document.getElementById('ap_paterno').value = user.ap_paterno.trim();
                document.getElementById('ap_materno').value = user.ap_materno.trim();
                document.getElementById('nombres').value = user.nombres.trim();
                document.getElementById('curp').value = user.curp.trim();
                document.getElementById('genero').value = user.genero.trim();
                document.getElementById('fecha_nacimiento').value = user.fecha_nacimiento === "0000-00-00" ? "" : user.fecha_nacimiento.trim();
                document.getElementById('nacionalidad').value = user.nacionalidad.trim();
                document.getElementById('telefono').value = user.telefono.trim();
                document.getElementById('lugar_origen').value = user.lugar_origen.trim();
                document.getElementById('direccion_actual').value = user.direccion_actual.trim();
                document.getElementById('imagen_url').value = user.imagen_url ? user.imagen_url.trim() : "";
                document.getElementById('cv_url').value = user.cv_url ? user.cv_url.trim() : "";
                document.getElementById('habilitado').value = user.habilitado;
                document.getElementById('primer_empleo_id').value = user.primer_empleo_id ? user.primer_empleo_id : "";
                document.getElementById('banderaEnc').value = user.banderaEnc;
                document.getElementById('carrera').value = user.carrera;
                document.getElementById('generacion').value = user.generacion;
                document.getElementById('fecha_inicio').value = user.fecha_inicio;
                document.getElementById('fecha_fin').value = user.fecha_fin;
                document.getElementById('promedio').value = user.promedio;
                document.getElementById('forma_titulacion').value = user.forma_titulacion ? user.forma_titulacion : "";
                document.getElementById('fecha_titulo').value = user.fecha_titulo ? user.fecha_titulo : "";
            } else {
                alert("No se encontraron datos para la matrícula proporcionada.");
            }
        })
        .catch(error => {
            console.error('Error al cargar los datos:', error);
            alert("Hubo un error al cargar los datos.");
        });
}


        document.getElementById("updateForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Evitar el envío por defecto

            const matricula = document.getElementById("matricula").value; // Obtener matrícula del formulario
            const formData = new FormData(event.target);
            const jsonObject = {};

            // Convertir FormData a JSON
            formData.forEach((value, key) => {
                if (key === "forma_titulacion") {
                switch (value) {
                    case "Tesis":
                        jsonObject[key] = 1;
                        break;
                    case "CENEVAL":
                        jsonObject[key] = 2;
                        break;
                    case "No titulado":
                        jsonObject[key] = 3;
                        break;
                    default:
                        jsonObject[key] = value; // En caso de que se agregue una nueva opción
                }
        } else {
            jsonObject[key] = value;
        }
            });

            // Hacer el request PUT al backend
            fetch(`/reales/${matricula}`, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(jsonObject) // Convertir datos a JSON
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => { throw error; });
                }
                return response.json();
            })
            .then(data => {
                console.log(data); // Manejar la respuesta del servidor
                alert('Egresado actualizado con éxito');
            })
            .catch(error => {
                console.error('Error:', error); // Manejar errores
                alert('Hubo un error al actualizar el egresado: ' + (error.detail || 'Error desconocido'));
            });
        });
            function logout() {
            // Eliminar el token del almacenamiento
            sessionStorage.removeItem('userToken');
            // Redirigir al usuario a la página de login
            window.location.href = "/login";
        }

        // Llamar a la función cuando el usuario haga clic en el botón de logout
        document.getElementById('logout').addEventListener('click', logout);

    </script>
</body>
</html>
